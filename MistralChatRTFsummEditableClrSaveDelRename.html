<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mistral AI Chat</title>

<style>
body {
    font-family: Arial;
    background: #f2f2f2;
}

#container {
    display: flex;
}

#left {
    width: 220px;
    background: #e8e8e8;
    border-right: 1px solid #999;
    padding: 6px;
}

#left button {
    width: 100%;
    margin-bottom: 6px;
}

.chat-item {
    padding: 6px;
    cursor: pointer;
    border-bottom: 1px solid #ccc;
}

.chat-item:hover {
    background: #dcdcdc;
}

#main {
    padding: 10px;
}

#header {
    position: relative;
    width: 700px;
}

#tokens {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 12px;
}

#toolbar button {
    width: 32px;
}

#chat {
    width: 700px;
    height: 420px;
    background: #fff;
    border: 1px solid #999;
    overflow-y: auto;
    padding: 10px;
}

.msg {
    border: 1px dashed #ccc;
    margin: 8px 0;
    padding: 4px;
}

.msg:focus {
    outline: 1px solid #666;
}

.user {
    color: blue;
    white-space: pre-wrap;
}

.ai {
    color: green;
}

textarea {
    width: 700px;
    height: 90px;
    resize: vertical;
}

button {
    height: 32px;
    margin-right: 6px;
}

select {
    height: 32px;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

<div id="container">

<!-- LEFT PANEL -->
<div id="left">
    <button onclick="newChat()">+ New Chat</button>
    <button onclick="saveChat()">Save Chat</button>
    <button onclick="exportChat()">Export</button>
    <button onclick="backupChats()">Backup</button>
    <button onclick="restoreChats()">Restore</button>
    <div style="font-size: 10px; color: red"><b>Del Chat</b> == Right-click</div>
	<div style="font-size: 10px; color: red"><b>Rename Chat</b> == Double-click to delete chat</div>
	<div id="chatList"></div>
</div>

<!-- MAIN -->
<div id="main">

<div id="header">
    <h3>Mistral AI Chat</h3>
    <div id="tokens">Tokens: 0</div>
</div>

<div id="toolbar">
    <button onclick="cmd('bold')"><b>B</b></button>
    <button onclick="cmd('italic')"><i>I</i></button>
    <button onclick="cmdColor('red')" style="color:red">A</button>
    <button onclick="cmdColor('blue')" style="color:blue;">A</button>
    <button onclick="cmdColor('green')" style="color:green;">A</button>
    <button onclick="cmdHighlight()">HL</button>
    <button onclick="cmd('removeFormat')">X</button>
	
</div>

<div id="chat"></div><br>
<br>
Model:
<select id="model">
    <option value="mistral-small">mistral-small</option>
    <option value="mistral-medium">mistral-medium</option>
    <option value="mistral-large">mistral-large</option>
</select>

<br><br>

<textarea id="input" placeholder="Type your prompt here&#10;Ctrl + Enter to send"></textarea>
<br>
<button onclick="send()">Send</button>
<button onclick="summarize()">Summarize & Continue</button>

</div>
</div>

<script>
const API_KEY = "JynhdEDbqBKOgVyMpoh71wgYjr56Yuad";
const API_URL = "https://api.mistral.ai/v1/chat/completions";

var currentChatId = null;

/* ---------------- LocalStorage ---------------- */

function getChats() {
    return JSON.parse(localStorage.getItem("mistral_chats") || "{}");
}

function setChats(obj) {
    localStorage.setItem("mistral_chats", JSON.stringify(obj));
}

/*function refreshChatList() {
    var list = document.getElementById("chatList");
    list.innerHTML = "";
    var chats = getChats();

    for (var id in chats) {
        var d = document.createElement("div");
        d.className = "chat-item";
        d.textContent = chats[id].name;
        d.onclick = (function(cid) {
            return function() { loadChat(cid); };
        })(id);
        list.appendChild(d);
    }
}*/


function refreshChatList() {
    var list = document.getElementById("chatList");
    list.innerHTML = "";
    var chats = getChats();

    for (var id in chats) {
        var d = document.createElement("div");
        d.className = "chat-item";
        d.textContent = chats[id].name;

        // Click = load
        d.onclick = (function(cid) {
            return function() {
                loadChat(cid);
            };
        })(id);

        // Double-click = rename
        d.ondblclick = (function(cid) {
            return function(e) {
                e.stopPropagation();
                renameChat(cid);
            };
        })(id);

        // Right-click = delete
        d.oncontextmenu = (function(cid) {
            return function(e) {
                e.preventDefault();
                deleteChat(cid);
            };
        })(id);

        list.appendChild(d);
    }
}


function newChat() {
    currentChatId = null;
    document.getElementById("chat").innerHTML = "";
    refreshChatList();
}

/*function saveChat() {
    var name = prompt("Chat name?");
    if (!name) return;

    var chats = getChats();
    var id = currentChatId || ("chat_" + Date.now());

    chats[id] = {
        name: name,
        html: document.getElementById("chat").innerHTML,
        timestamp: Date.now()
    };

    currentChatId = id;
    setChats(chats);
    refreshChatList();
}*/


function saveChat() {
    var chats = getChats();
    var id = currentChatId;

    // First-time save: ask for name
    if (!id) {
        var name = prompt("Chat name?");
        if (!name) return;

        id = "chat_" + Date.now();
        currentChatId = id;

        chats[id] = {
            name: name,
            html: document.getElementById("chat").innerHTML,
            timestamp: Date.now()
        };
    }
    // Existing chat: overwrite silently
    else {
        chats[id].html = document.getElementById("chat").innerHTML;
        chats[id].timestamp = Date.now();
    }

    setChats(chats);
    refreshChatList();
}


function renameChat(id) {
    var chats = getChats();
    if (!chats[id]) return;

    var newName = prompt("Rename chat:", chats[id].name);
    if (!newName) return;

    chats[id].name = newName;
    setChats(chats);
    refreshChatList();
}

function deleteChat(id) {
    if (!confirm("Delete this chat permanently?")) return;

    var chats = getChats();
    delete chats[id];
    setChats(chats);

    if (currentChatId === id) {
        currentChatId = null;
        document.getElementById("chat").innerHTML = "";
    }

    refreshChatList();
}


function loadChat(id) {
    var chats = getChats();
    if (!chats[id]) return;
    currentChatId = id;
    document.getElementById("chat").innerHTML = chats[id].html;
}

function backupChats() {
    var data = localStorage.getItem("mistral_chats");
    var blob = new Blob([data], { type: "application/json" });
    download(blob, "mistral_backup.json");
}

function restoreChats() {
    var input = document.createElement("input");
    input.type = "file";
    input.onchange = function() {
        var reader = new FileReader();
        reader.onload = function() {
            localStorage.setItem("mistral_chats", reader.result);
            refreshChatList();
        };
        reader.readAsText(input.files[0]);
    };
    input.click();
}

//=========================================================================
//   ADDED MISSING FUNCTIONS 
/* ---- Conversation memory ---- */

var systemMessage = {
    role: "system",
    content: "You are a helpful assistant. Continue the conversation using the full previous context."
};

var lastSentTokens = 0;
var lastReceivedTokens = 0;

function estimateTokens(text) {
    return Math.ceil(text.length / 4);
}

function updateTokenDisplay(chatData) {
    var total = 0;
    for (var i = 0; i < chatData.length; i++) {
        total += estimateTokens(chatData[i].content);
    }
    document.getElementById("tokens").textContent =
        "Memory: " + total +
        " | Sent: " + lastSentTokens +
        " | Reply: " + lastReceivedTokens;
}






//=========================================================================


/* ---------------- Export ---------------- */

function exportChat() {
    var html =
        "<html><head><meta charset='UTF-8'><style>" +
        document.querySelector("style").innerHTML +
        "</style></head><body>" +
        document.getElementById("chat").innerHTML +
        "</body></html>";

    download(new Blob([html], {type:"text/html"}), "chat_export.html");
}

function download(blob, name) {
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
}

/* ---------------- Formatting ---------------- */

function cmd(c) { document.execCommand(c,false,null); }
function cmdColor(c) { document.execCommand("foreColor",false,c); }
function cmdHighlight() {
    document.execCommand("hiliteColor",false,"yellow") ||
    document.execCommand("backColor",false,"yellow");
}

/* ---------------- Chat ---------------- */
/*
function send() {
    var t = input.value.trim();
    if (!t) return;
    input.value = "";

    var d = document.createElement("div");
    d.className = "msg";
    d.setAttribute("data-role","user");
    d.contentEditable = true;
    d.innerText = t;
    chat.appendChild(d);

    var msgs = buildChat();

    fetch(API_URL,{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+API_KEY
        },
        body:JSON.stringify({model:"mistral-small",messages:msgs})
    })
    .then(r=>r.json())
    .then(d=>{
        var a=document.createElement("div");
        a.className="msg";
        a.contentEditable=true;
        a.innerHTML=marked.parse(d.choices[0].message.content);
        chat.appendChild(a);
    });
}

function buildChat() {
    var arr = [];
    var nodes = chat.children;
    for (var i=0;i<nodes.length;i++) {
        arr.push({
            role: nodes[i].getAttribute("data-role")||"assistant",
            content: nodes[i].innerText
        });
    }
    return arr;
}
*/



//==============================================

/* ---- DOM-based chat handling ---- */

function addUser(text) {
    var d = document.createElement("div");
    d.className = "msg user";
    d.setAttribute("data-role", "user");
    d.setAttribute("contenteditable", "true");
    d.textContent = text;
    document.getElementById("chat").appendChild(d);
    scrollDown();
}

function addAI(markdown) {
    var d = document.createElement("div");
    d.className = "msg ai";
    d.setAttribute("data-role", "assistant");
    d.setAttribute("contenteditable", "true");
    d.innerHTML = marked.parse(markdown);
    document.getElementById("chat").appendChild(d);
    scrollDown();

    lastReceivedTokens = estimateTokens(markdown);
}

function scrollDown() {
    var c = document.getElementById("chat");
    c.scrollTop = c.scrollHeight;
}

/* ---- Build chatData from editable DOM ---- */

function buildChatDataFromDOM() {
    var nodes = document.getElementById("chat").children;
    var data = [];

    for (var i = 0; i < nodes.length; i++) {
        var role = nodes[i].getAttribute("data-role");
        var content = nodes[i].innerText.trim();
        if (content) {
            data.push({ role: role, content: content });
        }
    }
    return data;
}

function send() {
    var box = document.getElementById("input");
    var msg = box.value.trim();
    if (!msg) return;

    box.value = "";
    addUser(msg);

    var chatData = buildChatDataFromDOM();
    var payloadMessages = [systemMessage].concat(chatData);

    lastSentTokens = estimateTokens(JSON.stringify(payloadMessages));
    updateTokenDisplay(chatData);

    fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + API_KEY
        },
        body: JSON.stringify({
            model: document.getElementById("model").value,
            messages: payloadMessages
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        addAI(d.choices[0].message.content);
        updateTokenDisplay(buildChatDataFromDOM());
    })
    .catch(function() {
        addAI("Error contacting Mistral API.");
    });
}

/* ---- Summarize & Continue ---- */

function summarize() {
    var chatData = buildChatDataFromDOM();
    if (chatData.length < 2) {
        alert("Not enough conversation to summarize.");
        return;
    }

    var summaryPrompt = {
        role: "user",
        content:
            "Summarize the following conversation clearly and compactly, " +
            "preserving all important facts, names, and conclusions:\n\n" +
            JSON.stringify(chatData)
    };

    fetch(API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + API_KEY
        },
        body: JSON.stringify({
            model: document.getElementById("model").value,
            messages: [systemMessage, summaryPrompt]
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        document.getElementById("chat").innerHTML = "";
        addAI("Conversation summary:\n\n" + d.choices[0].message.content);
        updateTokenDisplay(buildChatDataFromDOM());
    })
    .catch(function() {
        addAI("Error during summarization.");
    });
}

/* Ctrl + Enter to send */
document.getElementById("input").addEventListener("keydown", function(e) {
    if (e.key === "Enter" && e.ctrlKey) {
        send();
        e.preventDefault();
    }
});

//================================================


refreshChatList();
</script>

</body>
</html>
